# Registry Enforcement System

**–¶–µ–ª—å:** –°–¥–µ–ª–∞—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª registry –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º –∏–ª–∏ –æ—á–µ–≤–∏–¥–Ω—ã–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.

**–ü—Ä–∏–Ω—Ü–∏–ø:** Fail fast, fail loud. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ ‚Äî –ª–µ–≥–∫–æ, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.

---

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (5 —Å–ª–æ—ë–≤)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Layer 1: SCHEMA (compile-time)                              ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ registry.schema.json ‚Üí validates registry.yaml structure    ‚îÇ
‚îÇ Blocks: invalid YAML, missing required fields               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Layer 2: CODEGEN (development-time)                         ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ registry.yaml ‚Üí registry.generated.ts (types + consts)      ‚îÇ
‚îÇ Blocks: typos in workflow_id, non-existent workflows        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Layer 3: RUNTIME (execution-time)                           ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ Workflow executor checks registry before start              ‚îÇ
‚îÇ Blocks: deprecated workflows, missing failure_model         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Layer 4: DRIFT DETECTION (continuous)                       ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ Cron job: filesystem vs registry every 6h                   ‚îÇ
‚îÇ Alerts: Telegram notification on drift                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Layer 5: CI/CD (pre-merge)                                  ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ GitHub Actions: schema + lint + codegen check               ‚îÇ
‚îÇ Blocks: PRs that break registry integrity                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Layer 1: Schema Validation

### –§–∞–π–ª: `registry.schema.json`

JSON Schema –¥–ª—è `registry.yaml`. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
- –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- –¢–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã (string, array, enum)
- Enum values –≤–∞–ª–∏–¥–Ω—ã (status: implemented|draft|deprecated)
- Cross-field validation (–µ—Å–ª–∏ status=implemented ‚Üí —Ç—Ä–µ–±—É–µ—Ç—Å—è failure_model)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# Pre-commit hook
npx ajv validate -s registry.schema.json -d registry.yaml

# –í lint-registry.sh
if command -v ajv &> /dev/null; then
  ajv validate -s registry.schema.json -d registry.yaml || exit 1
fi
```

**–ß—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç:**
- ‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ workflow –±–µ–∑ `version`
- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `status` (typo: "implemeted")
- ‚ùå Implemented workflow –±–µ–∑ `failure_model`
- ‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `updated_at`

---

## Layer 2: Code Generation

### –°–∫—Ä–∏–ø—Ç: `scripts/codegen-registry.ts`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç TypeScript –∏–∑ `registry.yaml`:

```typescript
// packages/shared/src/registry.generated.ts (auto-generated)

export type WorkflowId = 
  | 'system-review'
  | 'deep-research'
  | 'data-enrichment'
  | 'telegram-inbox'
  | 'email-inbox'
  // ... –≤—Å–µ workflows –∏–∑ registry

export type WorkflowStatus = 'implemented' | 'draft' | 'prompt-only' | 'deprecated';

export interface WorkflowMeta {
  version: string;
  updated_at: string;
  description: string;
  status: WorkflowStatus;
  stages?: string[];
  side_effects?: string[];
  replay_safety?: 'safe' | 'unsafe';
  // ...
}

export const REGISTRY: Record<WorkflowId, WorkflowMeta> = {
  'system-review': {
    version: '1.2.0',
    updated_at: '2026-01-31',
    description: '–ù–æ—á–Ω–æ–π –∞—É–¥–∏—Ç —Å–∏—Å—Ç–µ–º—ã',
    status: 'implemented',
    // ... –∏–∑ registry.yaml
  },
  // ...
} as const;

export function getWorkflow(id: WorkflowId): WorkflowMeta {
  return REGISTRY[id];
}

export function isWorkflowActive(id: WorkflowId): boolean {
  return REGISTRY[id].status !== 'deprecated';
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ:**
```typescript
// –î–æ: hardcoded string, typo possible
await executeWorkflow('sistem-review'); // ‚ùå typo

// –ü–æ—Å–ª–µ: type-safe
import { WorkflowId, getWorkflow } from '@elio/shared/registry.generated';

await executeWorkflow('system-review' satisfies WorkflowId); // ‚úÖ type-checked
// await executeWorkflow('sistem-review'); // ‚ùå TypeScript error!

const meta = getWorkflow('system-review');
console.log(meta.version); // "1.2.0"
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è:**
```bash
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ registry.yaml
npx tsx scripts/codegen-registry.ts

# Husky hook
# .husky/post-checkout
if git diff HEAD@{1} HEAD -- registry.yaml | grep -q '^[+-]'; then
  pnpm codegen:registry
fi
```

**–ß—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç:**
- ‚ùå Typos –≤ workflow_id (TypeScript compile error)
- ‚ùå –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É workflow
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ deprecated workflow –±–µ–∑ explicit check

---

## Layer 3: Runtime Enforcement

### –§–∞–π–ª: `packages/workflow/src/registry-loader.ts`

Workflow executor —á–∏—Ç–∞–µ—Ç registry –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:

```typescript
import { parse } from 'yaml';
import { readFileSync } from 'fs';
import { ELIO_ROOT } from '@elio/shared';

const REGISTRY_PATH = `${ELIO_ROOT}/registry.yaml`;

export class RegistryLoader {
  private static registry: any = null;

  static load() {
    if (!this.registry) {
      const content = readFileSync(REGISTRY_PATH, 'utf8');
      this.registry = parse(content);
    }
    return this.registry;
  }

  static validateWorkflow(workflowId: string): void {
    const registry = this.load();
    const workflow = registry.workflows[workflowId];

    if (!workflow) {
      throw new Error(
        `Workflow '${workflowId}' not found in registry. ` +
        `Add it to registry.yaml first.`
      );
    }

    if (workflow.status === 'deprecated') {
      const superseded = workflow.superseded_by;
      throw new Error(
        `Workflow '${workflowId}' is deprecated. ` +
        `Use '${superseded}' instead.`
      );
    }

    if (workflow.status === 'implemented') {
      // Implemented workflows must have complete metadata
      const required = ['version', 'failure_model', 'replay_safety', 'done_when'];
      for (const field of required) {
        if (!workflow[field]) {
          throw new Error(
            `Workflow '${workflowId}' is implemented but missing '${field}'. ` +
            `Update registry.yaml.`
          );
        }
      }
    }
  }

  static getWorkflowMeta(workflowId: string) {
    this.validateWorkflow(workflowId);
    return this.load().workflows[workflowId];
  }

  static checkReplaySafety(workflowId: string, dedupKey?: string): boolean {
    const meta = this.getWorkflowMeta(workflowId);
    
    if (meta.replay_safety === 'safe') {
      return true; // Always safe to replay
    }

    if (!meta.replay_guard) {
      throw new Error(
        `Workflow '${workflowId}' has replay_safety=unsafe but no replay_guard defined`
      );
    }

    // Check replay_guard logic (DB query for dedup key)
    // ...
    return false;
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
// elio/src/cli.ts
import { RegistryLoader } from '@elio/workflow/registry-loader';

async function runWorkflow(workflowId: string, args: any) {
  // BEFORE executing, validate via registry
  RegistryLoader.validateWorkflow(workflowId); // ‚úÖ Blocks if deprecated/invalid
  
  const meta = RegistryLoader.getWorkflowMeta(workflowId);
  console.log(`Starting ${workflowId} v${meta.version}`);
  
  // Check replay safety
  if (!RegistryLoader.checkReplaySafety(workflowId)) {
    throw new Error(`Workflow already ran recently (replay_guard check failed)`);
  }
  
  // Proceed with execution
  await executeWorkflowStages(workflowId, meta);
}
```

**–ß—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç:**
- ‚ùå –ó–∞–ø—É—Å–∫ workflow, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ registry
- ‚ùå –ó–∞–ø—É—Å–∫ deprecated workflow (—è–≤–Ω–∞—è –æ—à–∏–±–∫–∞)
- ‚ùå –ó–∞–ø—É—Å–∫ implemented workflow –±–µ–∑ complete metadata
- ‚ùå Replay unsafe workflow –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ dedup key

---

## Layer 4: Drift Detection

### –°–∫—Ä–∏–ø—Ç: `scripts/detect-registry-drift.ts`

Cron job (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. –í—Å–µ workflows –Ω–∞ –¥–∏—Å–∫–µ –µ—Å—Ç—å –≤ registry
2. –í—Å–µ deprecated workflows —É–¥–∞–ª–µ–Ω—ã —Å –¥–∏—Å–∫–∞
3. –í—Å–µ MCP –∞–¥–∞–ø—Ç–µ—Ä—ã referenced –≤ registry

```typescript
import { parse } from 'yaml';
import { readFileSync, readdirSync, existsSync } from 'fs';
import { notify } from '@elio/shared';

interface DriftReport {
  orphaned_workflows: string[]; // –ù–∞ –¥–∏—Å–∫–µ, –Ω–æ –Ω–µ—Ç –≤ registry
  orphaned_skills: string[];
  deprecated_on_disk: string[]; // Deprecated –≤ registry, –Ω–æ –µ—Å—Ç—å –Ω–∞ –¥–∏—Å–∫–µ
  orphaned_adapters: string[];
  missing_metadata: string[]; // Implemented –±–µ–∑ –ø–æ–ª–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
}

async function detectDrift(): Promise<DriftReport> {
  const registry = parse(readFileSync('registry.yaml', 'utf8'));
  const report: DriftReport = {
    orphaned_workflows: [],
    orphaned_skills: [],
    deprecated_on_disk: [],
    orphaned_adapters: [],
    missing_metadata: [],
  };

  // Check workflows on disk vs registry
  const workflowDirs = readdirSync('workflows', { withFileTypes: true })
    .filter(d => d.isDirectory() && d.name !== '_template')
    .map(d => d.name);

  for (const dir of workflowDirs) {
    if (!registry.workflows[dir]) {
      report.orphaned_workflows.push(dir);
    }
  }

  // Check deprecated workflows still on disk
  for (const [name, meta] of Object.entries(registry.workflows)) {
    if (meta.status === 'deprecated' && existsSync(`workflows/${name}`)) {
      report.deprecated_on_disk.push(name);
    }
  }

  // Check MCP adapters
  const adapterDirs = readdirSync('mcp-server/src/adapters', { withFileTypes: true })
    .filter(d => d.isDirectory() && d.name !== '__tests__')
    .map(d => d.name);

  for (const dir of adapterDirs) {
    const yamlContent = readFileSync('registry.yaml', 'utf8');
    if (!yamlContent.includes(dir)) {
      report.orphaned_adapters.push(dir);
    }
  }

  return report;
}

async function main() {
  const report = await detectDrift();
  const hasDrift = Object.values(report).some(arr => arr.length > 0);

  if (hasDrift) {
    const message = `‚ö†Ô∏è Registry Drift Detected!\n\n` +
      (report.orphaned_workflows.length > 0
        ? `Workflows on disk not in registry:\n${report.orphaned_workflows.map(w => `  - ${w}`).join('\n')}\n\n`
        : '') +
      (report.deprecated_on_disk.length > 0
        ? `Deprecated workflows still on disk:\n${report.deprecated_on_disk.map(w => `  - ${w}`).join('\n')}\n\n`
        : '') +
      (report.orphaned_adapters.length > 0
        ? `MCP adapters not in registry:\n${report.orphaned_adapters.map(a => `  - ${a}`).join('\n')}\n\n`
        : '') +
      `Run: ./scripts/lint-registry.sh`;

    await notify({ message, priority: 'high' });
    console.error(message);
    process.exit(1);
  } else {
    console.log('‚úÖ No drift detected. Registry and filesystem in sync.');
  }
}

main();
```

**Cron setup:**
```bash
# scheduler/config.json
{
  "jobs": [
    {
      "name": "registry-drift-detection",
      "schedule": "0 */6 * * *", // Every 6 hours
      "script": "npx tsx scripts/detect-registry-drift.ts",
      "notify_on_failure": true
    }
  ]
}
```

**–ß—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç:**
- ‚ö†Ô∏è Orphaned workflows (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
- ‚ö†Ô∏è Deprecated –Ω–∞ –¥–∏—Å–∫–µ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
- ‚ö†Ô∏è –ê–¥–∞–ø—Ç–µ—Ä—ã –±–µ–∑ registry entry (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)

---

## Layer 5: CI/CD (GitHub Actions)

### –§–∞–π–ª: `.github/workflows/validate-registry.yml`

```yaml
name: Registry Integrity Check

on:
  push:
    paths:
      - 'registry.yaml'
      - 'workflows/**'
      - 'skills/**'
      - 'mcp-server/src/adapters/**'
  pull_request:
    paths:
      - 'registry.yaml'
      - 'workflows/**'
      - 'skills/**'
      - 'mcp-server/src/adapters/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Registry
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq
      
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        run: |
          npm install -g ajv-cli
          pnpm install
      
      - name: Validate YAML schema
        run: npx ajv validate -s registry.schema.json -d registry.yaml
      
      - name: Lint registry
        run: ./scripts/lint-registry.sh
      
      - name: Check codegen is up-to-date
        run: |
          pnpm codegen:registry
          if ! git diff --exit-code packages/shared/src/registry.generated.ts; then
            echo "‚ùå registry.generated.ts is out of sync!"
            echo "Run: pnpm codegen:registry"
            exit 1
          fi
      
      - name: Detect drift
        run: npx tsx scripts/detect-registry-drift.ts
```

**–ß—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç:**
- ‚ùå Merge PR —Å invalid registry.yaml
- ‚ùå Merge PR —Å orphaned workflows
- ‚ùå Merge PR —Å outdated codegen

---

## üîÑ Workflow: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ workflow

### –î–æ (–±–µ–∑ enforcement)
```bash
# Developer –ø–∏—à–µ—Ç –∫–æ–¥
mkdir -p packages/my-workflow/src
# –ó–∞–±—ã–ª –¥–æ–±–∞–≤–∏—Ç—å –≤ registry!
git commit -m "Add my-workflow"
# ‚úÖ Commits —É—Å–ø–µ—à–Ω–æ, —Å–∏—Å—Ç–µ–º–∞ —Å–ª–æ–º–∞–Ω–∞
```

### –ü–æ—Å–ª–µ (—Å enforcement)
```bash
# 1. –°–Ω–∞—á–∞–ª–∞ registry (pre-commit hook –±–ª–æ–∫–∏—Ä—É–µ—Ç –µ—Å–ª–∏ –∑–∞–±—ã–ª)
vim registry.yaml  # –î–æ–±–∞–≤–∏—Ç—å my-workflow

# 2. Codegen –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (husky hook)
# ‚Üí registry.generated.ts –æ–±–Ω–æ–≤–ª—ë–Ω

# 3. –ü–∏—à–µ–º –∫–æ–¥ —Å type safety
import { WorkflowId } from '@elio/shared/registry.generated';
const id: WorkflowId = 'my-workflow'; // ‚úÖ Type-checked

# 4. Pre-commit hook
git add .
git commit -m "Add my-workflow"
# ‚Üí lint-registry.sh runs
# ‚Üí Schema validation runs
# ‚Üí ‚úÖ Commits —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å—ë –≤–∞–ª–∏–¥–Ω–æ

# 5. GitHub Actions (–Ω–∞ push)
# ‚Üí CI validates schema
# ‚Üí CI runs lint-registry.sh
# ‚Üí CI checks codegen is current
# ‚Üí ‚úÖ Merge —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å—ë –û–ö

# 6. Runtime (–ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)
elio workflow my-workflow
# ‚Üí RegistryLoader.validateWorkflow('my-workflow')
# ‚Üí ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç metadata, status, replay_safety

# 7. Drift detection (–∫–∞–∂–¥—ã–µ 6h)
# ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç filesystem vs registry
# ‚Üí ‚ö†Ô∏è Telegram alert –µ—Å–ª–∏ drift
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –î–æ vs –ü–æ—Å–ª–µ

| –°—Ü–µ–Ω–∞—Ä–∏–π | –î–æ | –ü–æ—Å–ª–µ |
|----------|-----|--------|
| –°–æ–∑–¥–∞—Ç—å workflow –±–µ–∑ registry entry | ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ | ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è pre-commit |
| Typo –≤ workflow_id | ‚úÖ Runtime error | ‚ùå TypeScript compile error |
| –ó–∞–ø—É—Å—Ç–∏—Ç—å deprecated workflow | ‚ö†Ô∏è Runs —Å warning | ‚ùå Runtime error —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã |
| –ó–∞–±—ã—Ç—å failure_model –¥–ª—è implemented | ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ | ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è lint + schema |
| Orphaned workflows –Ω–∞ –¥–∏—Å–∫–µ | ‚ö†Ô∏è –ù–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è | ‚ö†Ô∏è Telegram alert –∫–∞–∂–¥—ã–µ 6h |
| Outdated codegen | ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ | ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è CI |
| Invalid YAML syntax | ‚ö†Ô∏è Runtime error | ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è pre-commit |

---

## üöÄ Roadmap

### Phase 1: Foundation (—Å–µ–π—á–∞—Å)
- [x] Pre-commit hook (lint-registry.sh)
- [x] Basic validation

### Phase 2: Type Safety (1-2 –¥–Ω—è)
- [ ] registry.schema.json
- [ ] scripts/codegen-registry.ts
- [ ] registry.generated.ts
- [ ] Update workflow executor to use RegistryLoader

### Phase 3: Observability (1-2 –¥–Ω—è)
- [ ] scripts/detect-registry-drift.ts
- [ ] Cron job setup
- [ ] Telegram alerts

### Phase 4: CI/CD (1 –¥–µ–Ω—å)
- [ ] .github/workflows/validate-registry.yml
- [ ] Husky hooks –¥–ª—è codegen

### Phase 5: Polish (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] IDE extension –¥–ª—è autocomplete workflow_id
- [ ] Dashboard –≤ Notion —Å registry stats
- [ ] Auto-fix –¥–ª—è simple drift (—É–¥–∞–ª–µ–Ω–∏–µ deprecated)

---

## üéØ Success Metrics

**–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –≤—Å–µ—Ö —Å–ª–æ—ë–≤:**
- ‚úÖ 0 orphaned workflows
- ‚úÖ 0 runtime errors –∏–∑-–∑–∞ typos –≤ workflow_id
- ‚úÖ 100% coverage –¥–ª—è implemented workflows (all required fields)
- ‚úÖ < 1 hour –≤—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è drift (instead of days/weeks)
- ‚úÖ 0 PRs merged —Å broken registry

**–ü—Ä–∏–Ω—Ü–∏–ø:** Make it impossible to break, not just hard.
