# =============================================================================
# Elio OS — Registry v2.1
# =============================================================================
#
# ЕДИНСТВЕННЫЙ источник правды о всех сущностях системы.
# Этот файл ОБЯЗАТЕЛЕН к прочтению ПЕРЕД созданием чего-либо нового.
#
# =============================================================================
#
# ПРАВИЛА (для агента и человека):
#
# 1. ПЕРЕД СОЗДАНИЕМ — проверь registry.yaml
#    Если capability уже существует — модифицируй, не дублируй.
#
# 2. ПЕРЕД СОЗДАНИЕМ НОВОГО — сначала добавь запись сюда
#    Нет записи в registry = не существует.
#
# 3. ТРИ СУЩНОСТИ, НЕ БОЛЬШЕ:
#
#    SKILL — атомарная операция (1 шаг, без state)
#      Где документация: skills/{name}/SKILL.md
#      Где код (если есть): packages/{name}/
#      Где MCP адаптер (если есть): mcp-server/src/adapters/{name}/
#      type: prompt-only | package
#
#    WORKFLOW — multi-stage процесс (>=2 стадий, state, оркестратор)
#      Где документация: workflows/{name}/WORKFLOW.md
#      Где код: packages/{name}/ (TypeScript пакет @elio/{name})
#      Где shell wrapper: workflows/{name}/run.sh
#      Где MCP адаптер: mcp-server/src/adapters/{name}/
#
#    CONNECTOR — адаптер к внешнему сервису (без собственной логики)
#      Где код: mcp-server/src/adapters/{name}/
#      Это просто обёртка над API.
#
# 4. ПАПКА agents/ — УДАЛЕНА
#    "Agent" = workflow, который использует LLM. Это workflow, точка.
#    Промпты лежат в workflows/{name}/prompts/
#
# 5. ПРАВИЛО ОДНОЙ ТОЧКИ ВХОДА:
#    - Workflow код в packages/{name}/ (TypeScript пакет)
#    - Workflow docs в workflows/{name}/ (WORKFLOW.md, prompts, run.sh)
#    - Skill логика в packages/{name}/ (или prompt-only)
#    - skills/{name}/ = ТОЛЬКО документация (.md файлы)
#    - Shell wrapper = workflows/{name}/run.sh, <=20 строк
#
# 6. НЕ ДОПУСКАЕТСЯ:
#    - Два пакета для одной capability
#    - Код (ts/js) в skills/ (только docs)
#    - Код (ts/js) в workflows/ (только docs, prompts, run.sh)
#    - Shell скрипт с inline-логикой (if/else, парсинг, оркестрация)
#    - Новая папка верхнего уровня для "нового типа сущности"
#
# 7. VERSIONING:
#    Every skill/workflow MUST have `version` (semver) and `updated_at` (ISO date).
#    Bump version on any behavioral change.
#
# 8. FAILURE MODEL (workflows only):
#    Implemented workflows MUST declare failure_model: {retries, timeout, on_failure}
#
# 9. REPLAY SAFETY ENFORCEMENT:
#    Workflows with replay_safety: unsafe MUST have a replay_guard.
#    The executor MUST check workflow_runs for dedup key before starting.
#    Migration: 005_workflow_runs_trigger.sql adds replay_safe column.
#
# 10. COMPLETENESS:
#    Every entity on disk (skills/*/SKILL.md, workflows/*/WORKFLOW.md,
#    mcp-server/src/adapters/*/) MUST have a registry entry.
#    Validate with: scripts/lint-registry.sh
#
# =============================================================================

# -----------------------------------------------------------------------------
# SKILLS — атомарные операции
# -----------------------------------------------------------------------------
skills:

  web-search:
    description: "Поиск в интернете через DuckDuckGo/Serper"
    type: package
    package: packages/web-search
    docs: skills/web-search/SKILL.md
    mcp_tools: [duckduckgo_search, parse_webpage, serper_search]

  youtube-transcript:
    description: "Получение транскрипта YouTube видео"
    type: prompt-only
    docs: skills/youtube-transcript/SKILL.md

  code-review:
    description: "Ревью кода — безопасность, качество, стиль"
    type: package
    package: packages/code-review
    docs: skills/code-review/SKILL.md
    mcp_adapter: mcp-server/src/adapters/code-review

  auto-test:
    description: "Автоматический запуск и анализ тестов"
    type: prompt-only
    docs: skills/auto-test/SKILL.md

  deploy-website:
    description: "Деплой сайта"
    type: prompt-only
    docs: skills/deploy-website/SKILL.md

  # --- Maintenance skills (используются workflow system-review) ---
  brutal-audit:
    description: "Жёсткий аудит кода"
    type: prompt-only
    docs: skills/brutal-audit/SKILL.md

  code-cleanup:
    description: "Очистка кода от мусора"
    type: prompt-only
    docs: skills/code-cleanup/SKILL.md

  dep-maintenance:
    description: "Обновление зависимостей"
    type: prompt-only
    docs: skills/dep-maintenance/SKILL.md

  disk-cleanup:
    description: "Очистка диска"
    type: prompt-only
    docs: skills/disk-cleanup/SKILL.md

  docs-audit:
    description: "Аудит документации"
    type: prompt-only
    docs: skills/docs-audit/SKILL.md

  git-maintenance:
    description: "Обслуживание git-репозиториев"
    type: prompt-only
    docs: skills/git-maintenance/SKILL.md

  smoke-test:
    description: "Быстрый smoke-тест системы"
    type: prompt-only
    docs: skills/smoke-test/SKILL.md

  structure-audit:
    description: "Аудит структуры проекта"
    type: prompt-only
    docs: skills/structure-audit/SKILL.md

  person-research:
    description: "OSINT исследование человека из открытых источников"
    type: prompt-only
    docs: skills/person-research/SKILL.md

  intercom-opener:
    description: "Автооткрытие домофона: webhook принимает входящий звонок от Zadarma PBX и проигрывает DTMF ***** для открытия двери"
    type: prompt-only
    version: "1.0.0"
    updated_at: "2026-01-30"
    docs: skills/intercom-opener/SKILL.md
    service: intercom-opener.service
    infra:
      webhook_url: "https://getelio.co/zadarma/webhook"
      server: projects/intercom-opener/webhook-server.py
      systemd: /etc/systemd/system/intercom-opener.service
      nginx: /etc/nginx/sites-enabled/website.conf
      port: 3847
    zadarma:
      number: "+995706070051"
      pbx_id: 393129
      sound_id: "697c9c683612d1a940003890"
      sip_pbx: "941433"

  deep-research:
    description: "Skill-версия deep-research для ad-hoc исследования"
    type: prompt-only
    docs: skills/deep-research/SKILL.md

  system-review:
    description: "Skill-версия system-review для ручного аудита"
    type: prompt-only
    docs: skills/system-review/SKILL.md

# -----------------------------------------------------------------------------
# WORKFLOWS — multi-stage процессы
# -----------------------------------------------------------------------------
workflows:

  system-review:
    version: "1.1.0"
    updated_at: "2026-01-30"
    description: "Ночной аудит системы: Collect -> Analyze -> Fix -> Split Files -> Verify -> Report"
    code: packages/system-review
    docs: workflows/system-review/WORKFLOW.md
    script: workflows/system-review/run.sh
    mcp_adapter: mcp-server/src/adapters/system-review
    schedule: "0 3 * * *"
    stages: [collect, analyze, fix, split-files, verify, report, deliver]
    status: implemented
    side_effects: [git_commit, telegram_notify, file_modify]
    replay_safety: unsafe
    replay_guard: "Dedup by date in workflow_runs"
    done_when: "verify stage passes, report delivered to Telegram"
    failure_model:
      retries: 1
      timeout: "6h"
      on_failure: telegram_notify

  deep-research:
    version: "1.0.0"
    updated_at: "2026-01-30"
    description: "Глубокое исследование темы с отчётом в Notion"
    code: packages/deep-research
    docs: workflows/deep-research/WORKFLOW.md
    script: workflows/deep-research/run.sh
    mcp_adapter: mcp-server/src/adapters/deep-research
    mcp_tools: [deep_research, deep_research_resume, deep_research_status]
    stages: [discovery, planning, collection, factcheck, synthesis, devils_advocate, report, review]
    status: implemented
    side_effects: [notion_page_create, telegram_notify, perplexity_api]
    replay_safety: unsafe
    replay_guard: "Dedup by topic hash in workflow_runs"
    done_when: "Notion page URL returned and verified accessible"
    failure_model:
      retries: 1
      timeout: "45m"
      on_failure: telegram_notify

  data-enrichment:
    version: "1.0.0"
    updated_at: "2026-01-30"
    description: "Обогащение данных CSV/JSON/Notion через внешние API с отчётом в Notion"
    code: packages/data-enrichment
    docs: workflows/data-enrichment/WORKFLOW.md
    script: workflows/data-enrichment/run.sh
    stages: [discovery, planning, collection, validation, synthesis, export, report, verification]
    status: implemented
    side_effects: [notion_page_create, telegram_notify, file_write]
    replay_safety: unsafe
    replay_guard: "Dedup by input_hash in workflow_runs"
    done_when: "Export file generated and report in Notion"
    failure_model:
      retries: 1
      timeout: "30m"
      on_failure: telegram_notify

  telegram-inbox:
    version: "1.0.0"
    updated_at: "2026-01-30"
    description: "Обработка входящих Telegram сообщений"
    docs: workflows/telegram-inbox/WORKFLOW.md
    stages: [collect, classify, act, respond]
    status: prompt-only
    side_effects: [telegram_reply, task_create]
    replay_safety: safe
    done_when: "All messages classified and acted upon"

  email-inbox:
    version: "1.0.0"
    updated_at: "2026-01-30"
    description: "Обработка входящей почты"
    docs: workflows/email-inbox/WORKFLOW.md
    stages: [collect, classify, act, respond]
    status: prompt-only
    side_effects: [gmail_reply, task_create]
    replay_safety: safe
    done_when: "All emails classified and acted upon"

  meeting-prep:
    version: "1.0.0"
    updated_at: "2026-01-30"
    description: "Подготовка к встрече"
    docs: workflows/meeting-prep/WORKFLOW.md
    stages: [research, brief, deliver]
    status: prompt-only
    side_effects: [notion_page_create, telegram_notify]
    replay_safety: safe
    done_when: "Brief delivered to Notion and notified via Telegram"

  cold-outreach:
    version: "0.1.0"
    updated_at: "2026-01-30"
    description: "Подготовка холодного аутрича"
    docs: workflows/cold-outreach/WORKFLOW.md
    stages: [research, compose, review]
    status: draft
    side_effects: [file_create]
    replay_safety: safe
    done_when: "Outreach draft delivered for review"

  tz-builder:
    version: "1.0.0"
    updated_at: "2026-01-30"
    description: "Генерация ТЗ на новые workflows"
    docs: workflows/tz-builder/WORKFLOW.md
    stages: [discovery, research, architecture, spec_writing, verification]
    status: prompt-only
    side_effects: [file_create]
    replay_safety: safe
    done_when: "Spec file created and verified"

  day-review:
    version: "1.0.0"
    updated_at: "2026-01-30"
    description: "Утренний/вечерний обзор дня: что сделано, что запланировано"
    docs: workflows/day-review/WORKFLOW.md
    stages: [collect, summarize, deliver]
    status: prompt-only
    side_effects: [telegram_notify]
    replay_safety: safe
    done_when: "Summary delivered to Telegram"

  consilium:
    version: "1.0.0"
    updated_at: "2026-01-30"
    description: "Консилиум — мульти-модельное обсуждение"
    docs: workflows/consilium/WORKFLOW.md
    stages: [collect, discuss, synthesize, deliver]
    status: prompt-only
    side_effects: [telegram_notify]
    replay_safety: safe
    done_when: "Discussion summary delivered"

# -----------------------------------------------------------------------------
# CONNECTORS — адаптеры к внешним сервисам (без собственной бизнес-логики)
# -----------------------------------------------------------------------------
connectors:

  # Communication
  gmail:
    adapter: mcp-server/src/adapters/gmail
    tools_prefix: elio_gmail
  telegram:
    adapter: mcp-server/src/adapters/telegram
    tools_prefix: elio_telegram
  slack:
    adapter: mcp-server/src/adapters/slack
    tools_prefix: elio_slack

  # Productivity
  calendar:
    adapter: mcp-server/src/adapters/calendar
    tools_prefix: elio_calendar
  notion:
    adapter: mcp-server/src/adapters/notion
    tools_prefix: elio_notion
  google-docs:
    adapter: mcp-server/src/adapters/docs
    tools_prefix: elio_docs
  google-sheets:
    adapter: mcp-server/src/adapters/sheets
    tools_prefix: elio_sheets

  # Research APIs
  perplexity:
    adapter: mcp-server/src/adapters/perplexity
    tools_prefix: elio_perplexity
    credentials: secrets/perplexity.json
    models: [sonar, sonar-pro, sonar-reasoning]
    tools:
      - elio_perplexity_search
      - elio_perplexity_factcheck
    used_by:
      - deep-research  # collection stage — all 5 agents
    rate_limit: 30/min
    priority: primary  # primary research provider, AnySite = fallback
  brave:
    adapter: mcp-server/src/adapters/brave
  exa:
    adapter: mcp-server/src/adapters/exa
  serper:
    adapter: mcp-server/src/adapters/serper
  tavily:
    adapter: mcp-server/src/adapters/tavily
  semanticscholar:
    adapter: mcp-server/src/adapters/semanticscholar
  scrapedo:
    adapter: mcp-server/src/adapters/scrapedo

  # Social / Data
  linkedin:
    adapter: mcp-server/src/adapters/linkedin
    tools_prefix: elio_linkedin
  twitter:
    adapter: mcp-server/src/adapters/twitter
  youtube:
    adapter: mcp-server/src/adapters/youtube
    priority: primary
    overlaps_with: [anysite]
    note: "YouTube Data API v3 (свой ключ, 10K units/день). Предпочтительнее anysite."
  github:
    adapter: mcp-server/src/adapters/github
  anysite:
    adapter: mcp-server/src/adapters/anysite
    priority: fallback
    note: "Scraping-based. Shared лимит points. Fallback для YouTube/LinkedIn/Twitter."

  # AI
  grok:
    adapter: mcp-server/src/adapters/grok
  whisper:
    adapter: mcp-server/src/adapters/whisper
  notebooklm:
    adapter: mcp-server/src/adapters/notebooklm
  figma:
    adapter: mcp-server/src/adapters/figma

  # Telephony
  zadarma:
    adapter: null  # No MCP adapter, direct API via Python
    credentials: secrets/zadarma-credentials.txt
    api_key: secrets/zadarma-credentials.txt
    note: "VoIP provider. Georgian number +995706070051. API for PBX, IVR, numbers."
    used_by: [intercom-opener]

  # Automation
  n8n:
    adapter: mcp-server/src/adapters/n8n
    tools_prefix: elio_n8n

  # Data
  database:
    adapter: mcp-server/src/adapters/database
    tools_prefix: elio_database
  webscraping:
    adapter: mcp-server/src/adapters/webscraping
  sql:
    adapter: mcp-server/src/adapters/sql

  # Agents
  agents:
    adapter: mcp-server/src/adapters/agents
    tools_prefix: elio_agents
    note: "Background agent execution via Claude CLI"

  # System
  system:
    adapter: mcp-server/src/adapters/system
  # executor: REMOVED — functionality merged into @elio/workflow
  backlog:
    adapter: mcp-server/src/adapters/backlog
  community:
    adapter: mcp-server/src/adapters/community
  product-review:
    adapter: mcp-server/src/adapters/product-review
    tools_prefix: elio_product_review
    description: "Product quality review - analyzes feedback, errors, quality metrics"

# -----------------------------------------------------------------------------
# SHARED PACKAGES — библиотеки в packages/
# -----------------------------------------------------------------------------
shared_packages:
  shared:
    path: packages/shared
    description: "Unified logger (createLogger), notify(), rate-limiter, circuit-breaker, orchestrator, metrics. file-logger is deprecated shim."
    exports: [createLogger, logger, setLevel, notify, createStore, ELIO_ROOT, paths, LOG_PATHS]
  clients:
    path: packages/clients
    description: "HTTP клиенты к внешним API (gmail, notion, telegram, etc.)"
    exports: [perplexity, brave, serper, tavily, exa, grok, webscraping, twitter, community, linkedin, telegram, slack, github, youtube, semanticscholar]
  web-search:
    path: packages/web-search
    description: "Web search providers (DuckDuckGo, Serper)"
    exports: [search]
  db:
    path: packages/db
    description: "Database layer (Repository pattern, Supabase)"
    exports: [Database, getDb, Cache, Repositories]
  # executor: REMOVED — merged into @elio/workflow
  agent-runner:
    path: packages/agent-runner
    description: "CLI process management для background workflow execution"
    exports: [AgentRunner, createClaudeRunner, BoundedAsyncQueue, ProcessHandle]
  workflow:
    path: packages/workflow
    description: "BullMQ-based workflow orchestration и state management"
    exports: [BullMQWorkflowClient, WorkflowHandle, WorkflowState]
  skills:
    path: packages/skills
    description: "Skills runtime (auto-test, smoke-test, brutal-audit, cleanup, etc.)"
    exports: [autoTest, smokeTest, webSearch, codeCleanup, diskCleanup, gitMaintenance, depMaintenance, brutalAudit, docsAudit, structureAudit]
  telegram-bot:
    path: packages/telegram-bot
    description: "Telegram bot UI"

# -----------------------------------------------------------------------------
# STANDALONE PACKAGES — пакеты вне packages/
# Причина: имеют собственный CLI или являются самостоятельными приложениями.
# Все включены в pnpm-workspace.yaml.
# -----------------------------------------------------------------------------
standalone_packages:
  core:
    path: elio
    npm_name: "@elio/core"
    description: "Job Manager (BullMQ), Memory Manager, Skills — CLI: elio"
    status: implemented

  gtd:
    path: gtd
    npm_name: "@elio/gtd"
    description: "GTD task management system — CLI"
    status: implemented

  headless:
    path: headless
    npm_name: "@elio/headless"
    description: "Headless mode для background execution — CLI"
    status: minimal
    notes: "Functional executor/store/CLI but no integration with BullMQ pipeline"

  context-graph:
    path: context-graph
    npm_name: "@elio/context-graph"
    description: "Knowledge graph для entities/relationships — CLI"
    status: minimal
    notes: "JSON-file based, no Supabase integration"

  self-improvement:
    path: self-improvement
    npm_name: "@elio/self-improvement"
    description: "Learning system (corrections, patterns) — CLI"
    status: minimal
    notes: "JSON-file based, no automated pattern analysis"

  scheduler:
    path: scheduler
    npm_name: "@elio/scheduler"
    description: "Cron-based job scheduling"
    status: implemented

  worker:
    path: apps/worker
    npm_name: "@elio/worker"
    description: "Background agent execution workers (BullMQ consumers)"
    status: implemented

  figma-plugin:
    path: figma-plugin
    npm_name: "elio-figma-plugin"
    description: "Figma plugin — create designs from AI prompts"
    status: implemented

# -----------------------------------------------------------------------------
# MCP ADAPTER -> PACKAGE BRIDGES
# -----------------------------------------------------------------------------
# mcp-server/src/adapters/system-review/  -> @elio/system-review
# mcp-server/src/adapters/deep-research/  -> @elio/deep-research
# mcp-server/src/adapters/code-review/    -> @elio/code-review
# mcp-server/src/adapters/executor/       -> REMOVED (merged into @elio/workflow)

# -----------------------------------------------------------------------------
# STANDALONE SCRIPTS (not packages)
# -----------------------------------------------------------------------------
# These are NOT in pnpm-workspace.yaml and do NOT have package.json.
# Run directly with `npx tsx <file>`.
standalone_scripts:
  watchdog:
    path: watchdog
    description: "System health checker, auto-repair, seeder (checker.ts, repair.ts, seeder.ts, server.ts)"
    run: "npx tsx watchdog/server.ts"
    notes: "Standalone scripts, not a package. Uses direct file I/O, no shared deps."
